pipeline {
  agent { label 'staging' }  // åœ¨ staging èŠ‚ç‚¹è¿è¡Œï¼ˆæˆ–æ”¹ä¸º 'prod' è§†ç¯å¢ƒï¼‰

  stages {

    stage('Checkout Current Branch') {
      steps {
        checkout scm
      }
    }

    // ===============================================
    // æ ¸å¿ƒé˜¶æ®µï¼šåœ¨ Docker ä¸­è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹
    // ===============================================
    stage('Fetch Tests and Run Full Test Suite (in Docker)') {
      agent {
        docker {
          image 'python:3.11-slim'
          args '-u root' // rootæƒé™ä¾¿äº apt/pip å®‰è£…
        }
      }

      steps {
        script {
          sh '''
set -e  # å‡ºé”™ç«‹å³é€€å‡º

echo "ğŸ Setting up Python environment in Docker container"
apt-get update && apt-get install -y git
git config --global --add safe.directory ${WORKSPACE}

# ===========================================================
# 1ï¸âƒ£ ä» test åˆ†æ”¯æ‹‰å–æµ‹è¯•æ–‡ä»¶ä¸é…ç½®
# ===========================================================
echo "=== Fetching tests from origin/test branch ==="
git fetch origin test

rm -rf tmp_test_branch
mkdir tmp_test_branch

# å¯¼å‡º test æ–‡ä»¶å¤¹ä¸é…ç½®
git archive FETCH_HEAD test | tar -x -C tmp_test_branch || echo "âš ï¸ test folder not found"
git archive FETCH_HEAD test/pytest.ini test/conftest.py test/requirements.txt | tar -x -C tmp_test_branch || echo "âš ï¸ Some config files may not exist."

# æ‹·è´å›å½“å‰å·¥ä½œåŒº
for f in test pytest.ini conftest.py requirements.txt; do
  if [ -e tmp_test_branch/$f ]; then
    echo "âœ… Updating $f from test branch"
    rm -rf $f
    mv tmp_test_branch/$f ./
  else
    echo "âš ï¸ $f not found in test branch"
  fi
done

echo "Listing fetched test directory:"
ls -R test || echo "âš ï¸ test directory missing after fetch"

# ===========================================================
# 2ï¸âƒ£ å®‰è£…ä¾èµ–é¡¹
# ===========================================================
echo "=== Installing ALL dependencies ==="
if [ -f requirements.txt ]; then
  echo "ğŸ“¦ Installing test requirements..."
  pip install -r requirements.txt
else
  pip install pytest
fi

if [ -f app/requirements.txt ]; then
  echo "ğŸ“¦ Installing application requirements..."
  pip install -r app/requirements.txt
fi

# ===========================================================
# 3ï¸âƒ£ æ‰§è¡Œå®Œæ•´ pytest æµ‹è¯•
# ===========================================================
echo "=== Running full test suite ==="
pytest -v test/ --maxfail=1 --disable-warnings

echo "âœ… All tests passed successfully!"
'''
        }
      }
    }
  }

// ===============================================
  // ä¿®æ”¹ POST é˜¶æ®µï¼Œå¢åŠ è‡ªåŠ¨åˆå¹¶é€»è¾‘
  // ===============================================
  post {
    success {
      echo 'PIPELINE âœ… All tests passed.'
      
      script {
        // env.CHANGE_ID æ˜¯ Jenkins åœ¨ PR æ„å»ºæ—¶è‡ªåŠ¨è®¾ç½®çš„ PR ç¼–å·
        if (env.CHANGE_ID) {
          echo "Tests passed. Attempting to auto-merge PR #${env.CHANGE_ID}..."
          
          // ä½¿ç”¨ Jenkins çš„ 'withCredentials' æ¥å®‰å…¨åœ°åŠ è½½ Token
          // 'github-auto-merge-token' å¿…é¡»ä¸ä½ åœ¨ Jenkins ä¸­åˆ›å»ºçš„å‡­æ® ID ä¸€è‡´
          withCredentials([string(credentialsId: 'github-auto-merge-token', variable: 'GITHUB_TOKEN')]) {
            
            // ä½ çš„ä»“åº“ä¿¡æ¯
            def GITHUB_OWNER = 'swe40006pj'
            def REPO_NAME = 'Pipeline-Version-Control'

          
            sh """
            # ç¡®ä¿ staging èŠ‚ç‚¹å®‰è£…äº† curl
            # apt-get install curl -y (å¦‚æœéœ€è¦)
            
            curl -X PUT \
                 -H "Authorization: token ${GITHUB_TOKEN}" \
                 -H "Accept: application/vnd.github.v3+json" \
                 "https://api.github.com/repos/${GITHUB_OWNER}/${REPO_NAME}/pulls/${env.CHANGE_ID}/merge" \
                 -d '{"merge_method": "squash", "commit_title": "Auto-merge PR #${env.CHANGE_ID} by Jenkins CI", "delete_branch": true}'
            """
            
            echo "âœ… Successfully requested auto-merge for PR #${env.CHANGE_ID}."
          }
        } else {
          echo "Not a PR build (CHANGE_ID is null), skipping auto-merge."
        }
      }
    }
    failure {
      echo 'PIPELINE âŒ Some tests failed. Please review test results.'
    }
  }
}
