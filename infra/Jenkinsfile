pipeline {
  agent any

  stages {
    stage('Checkout Current Branch') {
      steps {
        checkout scm
      }
    }

    stage('Fetch Tests from test Branch') {
      steps {
        script {
          sh '''
            echo "=== Fetching tests from origin/test branch ==="
            git fetch origin test

            rm -rf tmp_test_branch
            mkdir tmp_test_branch

            # 导出 test 分支的测试相关文件
            git archive origin/test tests pytest.ini conftest.py requirements.txt | tar -x -C tmp_test_branch || echo "⚠️ Some files may not exist."

            # 替换到当前目录
            for f in tests pytest.ini conftest.py requirements.txt; do
              if [ -e tmp_test_branch/$f ]; then
                echo "✅ Updating $f from test branch"
                rm -rf $f
                mv tmp_test_branch/$f .
              else
                echo "⚠️ $f not found in test branch"
              fi
            done
          '''
        }
      }
    }

    stage('Compare Categories and Run Tests') {
      steps {
        script {
          sh '''
            echo "=== Setting up test environment ==="
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            else
              pip install pytest
            fi

            echo "=== Comparing categories between develop and current branch ==="

            # 获取 develop 分支版本的 app.py
            git fetch origin develop
            git show origin/develop:app/app.py > old_app.py
            cp app/app.py new_app.py

            # 提取 categories
            old_cats=$(grep -Eo "category=['\\\"]?[A-Za-z0-9_]+" old_app.py | awk -F= '{print tolower($2)}' | tr -d "'\\\"")
            new_cats=$(grep -Eo "category=['\\\"]?[A-Za-z0-9_]+" new_app.py | awk -F= '{print tolower($2)}' | tr -d "'\\\"")

            echo "Old categories: $old_cats"
            echo "New categories: $new_cats"

            # 找出新增 categories
            added_cats=""
            for c in $new_cats; do
              if ! echo "$old_cats" | grep -qw "$c"; then
                added_cats="$added_cats $c"
              fi
            done

            if [ -z "$added_cats" ]; then
              echo "✅ No new categories found. Skipping selective test run."
              exit 0
            fi

            echo "🧩 New categories detected: $added_cats"

            # 逐个运行测试
            missing_tests=0
            failed_tests=0
            for cat in $added_cats; do
              echo "▶ Running tests for category: $cat"
              pytest -k "$cat" || {
                status=$?
                if [ $status -eq 5 ]; then
                  echo "❌ No test found for category '$cat'"
                  missing_tests=1
                else
                  echo "❌ Some tests failed for category '$cat'"
                  failed_tests=1
                fi
              }
            done

            if [ $missing_tests -eq 1 ]; then
              echo "❌ Missing tests for one or more categories."
              exit 1
            fi

            if [ $failed_tests -eq 1 ]; then
              echo "❌ One or more tests failed."
              exit 1
            fi

            echo "✅ All new categories have tests and all passed!"
          '''
        }
      }
    }
  }

  post {
    success {
      echo 'PIPELINE ✅ All category tests passed.'
    }
    failure {
      echo 'PIPELINE ❌ Some tests failed or missing.'
    }
  }
}
